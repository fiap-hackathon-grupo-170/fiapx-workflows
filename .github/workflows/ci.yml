name: CI

on:
  workflow_call:
    inputs:
      java-version:
        required: false
        type: string
        default: "17"
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  quality:
    name: Quality Analysis
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: maven

      - name: Build and Test Application
        run: mvn -B clean verify

      - name: JaCoCo Coverage (min 80%)
        id: jacoco
        continue-on-error: true
        run: |
          mvn -B jacoco:check
          $exitCode = $LASTEXITCODE
          "exit_code=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: SonarCloud Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar `
            "-Dsonar.host.url=${{ vars.SONAR_HOST_URL }}" `
            "-Dsonar.organization=${{ vars.SONAR_ORG_KEY }}" `
            "-Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}"

      - name: Validate New Coverage (80% for PR)
        if: github.event_name == 'pull_request'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          $PR_NUMBER = "${{ github.event.pull_request.number }}"
          $MIN_COVERAGE = 80

          Write-Host "Verificando coverage do PR #$PR_NUMBER..."
          Start-Sleep -Seconds 10

          $url = "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ vars.SONAR_PROJECT_KEY }}&pullRequest=$PR_NUMBER"

          $response = Invoke-RestMethod `
            -Uri $url `
            -Headers @{ Authorization = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("$($env:SONAR_TOKEN):")) }

          $newCoverage = $response.projectStatus.conditions |
            Where-Object { $_.metricKey -eq "new_coverage" } |
            Select-Object -ExpandProperty actualValue

          if (-not $newCoverage -or $newCoverage -eq "null") {
              Write-Host "Métrica 'new_coverage' não disponível - ignorando validação"
              exit 0
          }

          $coverage = [double]$newCoverage

          Write-Host "New Coverage: $coverage%"
          Write-Host "Mínimo: $MIN_COVERAGE%"

          if ($coverage -ge $MIN_COVERAGE) {
              $msg = "Coverage OK ({0}% >= {1}%)" -f $coverage, $MIN_COVERAGE
              Write-Host $msg
              exit 0
          }
          else {
              $msg = "Coverage insuficiente ({0}% < {1}%)" -f $coverage, $MIN_COVERAGE
              Write-Host $msg
              exit 1
          }

      - name: Post JaCoCo Coverage
        if: always()
        run: |
          if ("${{ steps.jacoco.outputs.exit_code }}" -ne "0") {
              Write-Host "Coverage mínimo NÃO atingido"
              exit 1
          }
          else {
              Write-Host "Coverage mínimo atingido"
          }
