name: CI

on:
  workflow_call:
    inputs:
      java-version:
        required: false
        type: string
        default: "17"
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  quality:
    name: Quality Analysis
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: maven

      - name: Build and Test Application
        run: mvn -B clean verify

      - name: JaCoCo Coverage (min 80%)
        id: jacoco
        continue-on-error: true
        run: |
          mvn -B jacoco:check -Djacoco.failOnViolation=true
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: SonarCloud Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.host.url=${{ vars.SONAR_HOST_URL }} \
            -Dsonar.organization=${{ vars.SONAR_ORG_KEY }} \
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }}

      - name: Validate New Coverage (80% for PR)
        shell: bash
        if: github.event_name == 'pull_request'
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          MIN_COVERAGE=80

          echo "üîç Verificando coverage do PR #$PR_NUMBER..."
          sleep 10

          RESPONSE=$(curl -s -u "$SONAR_TOKEN:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ vars.SONAR_PROJECT_KEY }}&pullRequest=$PR_NUMBER")

          NEW_COVERAGE=$(echo "$RESPONSE" | jq -r '
            .projectStatus.conditions[] 
            | select(.metricKey == "new_coverage") 
            | .actualValue
          ')

          if [ -z "$NEW_COVERAGE" ] || [ "$NEW_COVERAGE" = "null" ]; then
            echo "‚ö†Ô∏è  M√©trica 'new_coverage' n√£o dispon√≠vel - ignorando valida√ß√£o"
            exit 0
          fi

          COVERAGE=$(printf "%.2f" "$NEW_COVERAGE")

          echo "üìä New Coverage: $COVERAGE%"
          echo "üéØ M√≠nimo: $MIN_COVERAGE%"

          if (( $(echo "$COVERAGE >= $MIN_COVERAGE" | bc -l) )); then
            echo "‚úÖ Coverage OK ($COVERAGE% >= $MIN_COVERAGE%)"
            exit 0
          else
            echo "‚ùå Coverage insuficiente ($COVERAGE% < $MIN_COVERAGE%)"
            exit 1
          fi

      - name: Post JaCoCo Coverage
        shell: bash
        if: always()
        run: |
          if [ "${{ steps.jacoco.outputs.exit_code }}" != "0" ]; then
            echo "‚ùå Coverage m√≠nimo N√ÉO atingido"
            exit 1
          else
            echo "‚úÖ Coverage m√≠nimo atingido"
          fi
